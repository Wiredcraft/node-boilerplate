var path = require('path');
var fs = require('fs');

// Register every file in a dir plus a namespace.
exports.register = function(dir, namespace) {
    namespace || (namespace = 'plugins');
    // TODO: validate namespace.
    exports[namespace] || (exports[namespace] = {});
    exports.require(dir, namespace);
};

// .
exports.require = function(dir, namespace) {
    dir = path.join(dir, namespace);
    try {
        fs.readdirSync(dir).sort(alphabetical).forEach(function(name) {
            var component = require(path.join(dir, name));
            if (!component.title) component.title = name.replace(/\..+$/, '');
            exports[namespace][component.title] = component;
        });
    } catch (err) {
        throw err;
    }
};

// Get a plugin.
exports.get = function(namespace, title) {
    if (!exports[namespace] || !exports[namespace][title]) {
        return false;
    }
    return exports[namespace][title];
};

// Register.
exports.register(__dirname, 'constructors');

// Helpers
// -------

// .
function alphabetical(a, b) {
    return a.toLowerCase().localeCompare(b.toLowerCase());
}

// ----
// Demo
// ----
var http = require('http');
var express = require('express');

// .
exports.start = function() {
    var app = express();

    app.configure(function() {
        app.set('port', process.env.PORT || 3000);
        app.use(express.favicon());
        app.use(express.logger('dev'));
        app.use(express.bodyParser());
        app.use(express.methodOverride());
        app.use(express.cookieParser('your secret here'));
        app.use(express.session());
    });

    app.configure('development', function() {
        app.use(express.errorHandler());
    });

    app.get('/', function(req, res) {
        res.json({
            title: 'Express'
        });
    });

    http.createServer(app).listen(app.get('port'), function() {
        console.log('Express server listening on port ' + app.get('port'));
    });
};
